<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>聊天记录</title>

  <link rel="stylesheet" href="__layuiadmin__/layui/css/layui.css">
  <style>
    body .layim-chat-main {
      height: auto;
    }
  </style>
</head>
<body>

<div class="layim-chat-main">
  <ul id="LAY_view"></ul>
</div>

<div id="LAY_page" style="margin: 0 10px;"></div>

<textarea title="消息模版" id="LAY_tpl" style="display:none;">
{{# layui.each(d.data, function(index, item){
  if(item.id == parent.layui.layim.cache().mine.id){ }}
    <li class="layim-chat-mine">
      <div class="layim-chat-user">
        <img src="{{ item.avatar }}">
        <cite><i>{{ layui.data.date(item.timestamp) }}</i>{{ item.username }}</cite>
      </div>
      <div class="layim-chat-text">{{ layui.layim.content(item.content) }}</div>
    </li>
  {{# } else { }}
    <li>
      <div class="layim-chat-user">
        <img src="{{ item.avatar }}">
        <cite>{{ item.username }}<i>{{ layui.data.date(item.timestamp) }}</i></cite>
      </div>
      <div class="layim-chat-text">{{ layui.layim.content(item.content) }}</div>
    </li>
  {{# }
}); }}
</textarea>

<!--
上述模版采用了 laytpl 语法，不了解的同学可以去看下文档：http://www.layui.com/doc/modules/laytpl.html
-->


<script src="__layuiadmin__/layui/layui.js"></script>
<script>
    layui.use(['layim', 'laypage'], function () {
        var laytpl = layui.laytpl,
            $ = layui.jquery,
            laypage = layui.laypage;

        function getChatLog(page = 1, limit = 10) {
            $.ajax({
                url: '/chat/chatlog',
                type: 'GET',
                data: location.search.substr(1) + '&page=' + page + '&limit=' + limit,//获得URL参数。该窗口url会携带会话id和type，他们是你请求聊天记录的重要凭据
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    if (res.code === 0) {
                        var html = laytpl(LAY_tpl.value).render({
                            data: res.data.list
                        });
                        $('#LAY_view').html(html);

                        laypage.render({
                            elem: 'LAY_page',  //注意，这里的 test1 是 ID，不用加 # 号
                            count: res.data.count, //数据总数，从服务端得到
                            curr: page,
                            limit: limit,
                            layout: ['prev', 'page', 'next', 'count', 'limit', 'skip', 'refresh'],
                            jump: function (obj, first) {
                                //obj包含了当前分页的所有参数，比如：
                                console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。
                                console.log(obj.limit); //得到每页显示的条数
                                //首次不执行
                                if (!first) {
                                    getChatLog(obj.curr, obj.limit);
                                }
                            }
                        });
                    }
                },
                error: function (res) {
                    console.log(res)
                }
            });
        }

        //开始请求聊天记录
        getChatLog();
    });
</script>
</body>
</html>
